# Session Log — 20 Feb 2026

## Контекст
Система управления топливом REV 3.0 — fuel.kittykat.tech/rev3/
Backend: PHP, MySQL (d105380_fuelv3 @ d105380.mysql.zonevs.eu)
Frontend: Vue 3 + Vite + TailwindCSS
Server: virt105026@kittykat.tech → ~/domeenid/www.kittykat.tech/fuel/rev3/
GitHub: github.com/joinreachout/fuel-management-v3

---

## Проблема с которой начали
Виджеты дашборда (прогнозный график, procurement advisor) не работали
потому что таблица `sales_params` была заполнена нулями (liters_per_day = 0).
Без расхода топлива система не может считать days_until_empty и строить прогнозы.

---

## Что было сделано

### 1. Диагностика таблицы sales_params
Выяснили через phpMyAdmin что:
- Бишкек БиМM и ХОП — реальные данные (из старой БД)
- Жалал-Абад ГНС — реальные данные
- Все остальные депо — liters_per_day = 0

### 2. Получили реальные названия всех депо (depot_id)
```
174  ГНС Аламедин        (Станция Аламедин)
153  БиМM                (Станция Бишкек) — реальные данные
154  ХОП                 (Станция Бишкек) — реальные данные
166  ГНС Жалал Абад      (Станция Жалал-Абад) — реальные данные
160  Жалал-Абад-1        (Станция Жалал-Абад)
161  Жалал-Абад-2        (Станция Жалал-Абад)
162  Жалал-Абад-3        (Станция Жалал-Абад)
151  Каинда              (Станция Каинда)
152  Каинда Ойл          (Станция Каинда)
148  Каинда-1            (Станция Каинда)
149  Каинда-2            (Станция Каинда)
150  Каинда-3            (Станция Каинда)
167  ГНС Кызыл Кия       (Станция Кызыл-Кыя)
163  Кызыл-Кыя           (Станция Кызыл-Кыя)
157  МЦС Ош              (Станция ОШ)
165  ГНС Балыкчы         (Станция Рыбачье)
155  НБ Балыкчы          (Станция Рыбачье)
156  НБ Токмок           (Станция Токмок)
164  ГНС Сокулук         (Станция Шопоков)
```

### 3. Коды топлива в БД (fuel_types)
```
id=24  GAS92     А-92
id=25  DIESB7    Дизель B7
id=26  GAZ       LPG (сжиженный газ)
id=27  JET       Авиатопливо
id=28  MTBE      MTBE (присадка)
id=31  GAS95     А-95
id=32  GAS98     А-98
id=33  DIESB10   Дизель B10
id=34  GAS80     А-80
id=35  GAS92EUR  А-92 Euro
```

### 4. Источник данных о расходе
Из Excel model_v02.xls (реальные данные пользователя, литры/сутки по станциям):
```
Каинда:      Автобензины=215000, ДТ=170000, Газ=0
Бишкек:      Автобензины=166600, ДТ=65000,  Газ=0
Токмок:      Автобензины=75000,  ДТ=60000,  Газ=0
Рыбачье:     Автобензины=110000, ДТ=90000,  Газ=40000
ОШ:          Автобензины=190000, ДТ=105000, Газ=0
Жалал-Абад:  Автобензины=220000, ДТ=100000, Газ=55000
Кызыл-Кыя:   Автобензины=110000, ДТ=35000,  Газ=35000
Шопоков:     Автобензины=200000, ДТ=60000,  Газ=0
Аламедин:    Автобензины=150000, ДТ=55000,  Газ=0 (оценка)
```

### 5. Пропорции разбивки по видам топлива (согласованы с пользователем)
```
Автобензины:
  GAS80    = 25%
  GAS92    = 45%
  GAS95    = 15%
  GAS92EUR = 10%
  GAS98    = 5%
  MTBE     = 2% (для картинки)

Дизель:
  DIESB7   = 70%
  DIESB10  = 30%

Газ:        как есть (по станции)
JET:        только Бишкек (1500 л/день) и ОШ (800 л/день)
```

### 6. SQL миграция 005_fill_sales_params.sql
Файл: database/migrations/005_fill_sales_params.sql

**Шаг 1** — Сброс всех не-реальных данных:
```sql
UPDATE sales_params SET liters_per_day = 0
WHERE depot_id NOT IN (153, 154, 166) AND effective_to IS NULL;
```

**Шаг 2** — UPDATE по depot_id (точные ID, без LIKE) для всех депо.
Реальные данные (153=БиМM, 154=ХОП, 166=ГНС Жалал-Абад) не трогались
(защита WHERE liters_per_day = 0).

**Шаг 3** — INSERT недостающих строк для топлива которого не было в sales_params:
```sql
INSERT INTO sales_params (depot_id, fuel_type_id, liters_per_day, effective_from)
SELECT d.id, f.id, 0, '2025-01-01'
FROM depots d CROSS JOIN fuel_types f
WHERE d.is_active = 1
  AND f.code IN ('GAS80', 'GAS95', 'GAS92EUR', 'GAS98', 'DIESB10')
  AND NOT EXISTS (
    SELECT 1 FROM sales_params sp
    WHERE sp.depot_id = d.id AND sp.fuel_type_id = f.id AND sp.effective_to IS NULL
  );
```
После INSERT — повторный UPDATE заполнил новые строки значениями.

### 7. Итоговые значения в sales_params (примеры)
```
depot 153 БиМM:    DIESB7=85001, GAS92=128190, GAZ=20000, JET=813, MTBE=892 (реальные)
depot 154 ХОП:     DIESB7=85000, GAS92=128190, JET=813, MTBE=892 (реальные)
depot 166 ГНС ЖА:  DIESB7=118000, GAS92=229007, GAZ=82000, JET=1000 (реальные)
depot 151 Каинда:  GAS92=96750, GAS80=53750, DIESB7=119000 и т.д.
depot 157 МЦС Ош:  GAS92=85500, DIESB7=73500, JET=800 и т.д.
```

---

## Проблемы с которыми столкнулись и решения

### Проблема 1: LIKE '%Каинда%' попал на 5 депо → GAS92 умножился в 5 раз
**Решение:** Переписали SQL используя точные depot_id вместо LIKE по названию.

### Проблема 2: LIKE '%Шопоков%' не нашёл депо — оно называется "ГНС Сокулук"
**Решение:** То же — точные depot_id.

### Проблема 3: GAS80, GAS95, GAS92EUR, GAS98, DIESB10 — 0 строк в sales_params
Эти виды топлива не существовали в старой БД и не были скопированы при миграции.
**Решение:** INSERT новых строк + UPDATE.

### Проблема 4: График показывал только DIESB7, GAS92, GAZ, MTBE, JET
Причина та же — остальные виды не имели строк в sales_params.
**Решение:** После INSERT+UPDATE все виды топлива появились на графике.

---

## Изменения в коде (frontend)

### Dashboard.vue — улучшение empty state для прогнозного графика
Вместо generic "No Forecast Data Available" теперь:
- Если выбрана станция + топливо → "Fuel type not available at this station"
  с названием топлива и станции
- Если только станция → "No data for this station"
- Fallback → стандартное сообщение
- Блок Required Data сохранён во всех случаях

---

## Деплой
```bash
# Локально:
cd frontend && npm run build
git add -f frontend/dist/ frontend/src/views/Dashboard.vue
git commit -m "..." && git push origin main

# На сервере:
ssh -i ~/.ssh/id_kittykat virt105026@kittykat.tech
cd ~/domeenid/www.kittykat.tech/fuel/rev3 && git pull origin main
```

---

## Текущее состояние системы
- ✅ sales_params заполнены для всех депо и всех видов топлива
- ✅ depot_tanks заполнены (30-85% от capacity) — из предыдущей сессии
- ✅ stock_policies заполнены (20%=critical, 40%=min, 80%=target)
- ✅ Прогнозный график работает для всех видов топлива где есть танки
- ✅ Умные сообщения когда топлива нет на станции
- ✅ Station Fill Levels и Stock by Fuel Type — на всю ширину
- ❓ Orders Calendar — пустой, нужно наполнить
- ❓ Procurement Advisor — нужно проверить что считает правильно

---

---

## Migration 006: Seed Orders (006_seed_orders.sql)

**Файл:** `database/migrations/006_seed_orders.sql`
**Статус:** Создан, нужно выполнить в phpMyAdmin

**Цель:** Наполнить таблицу `orders` реалистичными заказами чтобы:
1. Orders Calendar показывал данные
2. Прогнозный график показывал скачки вверх в дни доставки

**Количество заказов: 38**
- 15 × `delivered` — прошлые доставки (30-75 дней назад)
- 11 × `in_transit` — в пути (прибывают через 3-14 дней)
- 12 × `confirmed` — запланированы (прибывают через 28-37 дней)

**Параметры заказов:**
```
Поставщик:   КрНПЗ (supplier_id=7), срок доставки 30-37 дней
Объёмы:
  GAS92:  60 вагонов × 60 т ÷ 0.735 = 4,900,000 L
  DIESB7: 60 вагонов × 60 т ÷ 0.830 = 4,300,000 L
  GAZ:    30 вагонов × 60 т ÷ 0.535 = 3,360,000 L
```

**Охват станций:**
```
Бишкек    (250, depot 153):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
Каинда    (249, depot 151):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
ОШ        (252, depot 157):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
Жалал-Абад(253, depot 160):  GAS92 + DIESB7 + GAZ — доставлено, в пути, подтверждено
Рыбачье   (251, depot 165):  GAS92 + DIESB7 + GAZ — доставлено, в пути, подтверждено
Кызыл-Кыя (254, depot 163):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
Шопоков   (255, depot 164):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
Аламедин  (256, depot 174):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
Токмок    (257, depot 156):  GAS92 + DIESB7 — доставлено, в пути, подтверждено
```

**Ключевые номера заказов:**
- `ORD-2025-001` ... `ORD-2025-015` — delivered (past)
- `ORD-2026-001` ... `ORD-2026-011` — in_transit
- `ORD-2026-021` ... `ORD-2026-038` — confirmed (future)

---

## ForecastService.php — интеграция заказов в прогноз

**Файл:** `backend/src/Services/ForecastService.php`
**Метод:** `getStationForecast()`

**Было (линейный спад, заказы не учитывались):**
```php
for ($i = 0; $i <= $days; $i++) {
    $projectedStock = $currentStock - ($dailyConsumption * $i);
    $stockData[] = max(0, round($projectedStock, 2));
}
```

**Стало (с учётом доставок из orders):**
1. Перед циклом — запрос заказов со статусом `confirmed` / `in_transit`
   в окне прогноза (CURDATE до CURDATE + $days):
```sql
SELECT o.delivery_date, SUM(o.quantity_liters) as total_liters
FROM orders o
WHERE o.station_id = ?
  AND o.fuel_type_id = ?
  AND o.delivery_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL ? DAY)
  AND o.status IN ('confirmed', 'in_transit')
GROUP BY o.delivery_date
```
2. Карта доставок: `['2026-02-25' => 4900000, ...]`
3. В цикле — день-за-днём, добавляем доставку в день прибытия:
```php
$deliveryToday = $deliveries[date('Y-m-d', strtotime("+{$i} days"))] ?? 0;
$projectedStock = $projectedStock - $dailyConsumption + ($deliveryToday / 1000); // kL
$projectedStock = max(0, min($capacity, $projectedStock));
$stockData[] = round($projectedStock, 2);
```
4. Результат: график показывает скачки вверх в дни доставки.

---

## Текущее состояние системы (обновлено)
- ✅ sales_params заполнены для всех депо и всех видов топлива
- ✅ depot_tanks заполнены (30-85% от capacity)
- ✅ stock_policies заполнены (20%=critical, 40%=min, 80%=target)
- ✅ Прогнозный график работает (линейный спад)
- ✅ Умные сообщения когда топлива нет на станции
- ✅ Station Fill Levels и Stock by Fuel Type — на всю ширину
- ✅ 006_seed_orders.sql создан (38 заказов)
- ⏳ 006_seed_orders.sql нужно выполнить в phpMyAdmin
- ⏳ ForecastService.php обновлён (интеграция доставок) — нужен деплой
- ❓ Procurement Advisor — нужно проверить

## Следующий шаг (если прерваться)
1. Выполнить `database/migrations/006_seed_orders.sql` в phpMyAdmin
2. На сервере: `git pull origin main`
3. Открыть дашборд → Fuel Level Forecast → выбрать DIESB7 / All Stations
4. Убедиться что линии прыгают вверх в дни доставки
