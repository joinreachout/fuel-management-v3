# Session 2026-02-23 — Orders Module: PO vs ERP Order Type Split

> Duration: ~4h
> Commit: `feat: Orders module — PO vs ERP order type separation (migration 008)`

---

## Problem Identified

The `orders` table was mixing two fundamentally different kinds of records:
- **Purchase Orders** — created by user as a planning/printing document
- **ERP Orders** — real supply confirmations from 1C/ERP system

This caused a critical architectural issue:
- User could accidentally try to manage ERP statuses (`confirmed → in_transit → delivered`) via the UI — but that's ERP's job
- Forecast chart was potentially double-counting (both PO and ERP order for same delivery)
- No way to tell if a PO was acted upon by ERP or just ignored

---

## Solution: `order_type` Column

Added `order_type ENUM('purchase_order', 'erp_order')` to distinguish the two flows.

### User clarifications (Q&A):
1. **POs on forecast?** → No. Only ERP orders show as delivery bumps.
2. **PO lifecycle?** → `planned` → `matched` (ERP confirmed) | `expired` (date passed) | `cancelled` (user error only)
3. **Procurement Advisor?** → When PO exists for a station/fuel, show "PO Issued — Awaiting ERP" badge instead of "Create Order" button.
4. **Auto-matching?** → When ERP order imported, search for PO with same station+fuel+date ±7 days → mark PO as `matched`.

---

## What Was Done

### 1. Migration 008 (`database/migrations/008_order_type.sql`)
```sql
ALTER TABLE orders
  ADD COLUMN order_type ENUM('purchase_order', 'erp_order') NOT NULL DEFAULT 'purchase_order' AFTER order_number,
  ADD COLUMN erp_order_id INT NULL AFTER cancelled_at,
  ADD COLUMN matched_at DATETIME NULL AFTER erp_order_id;

ALTER TABLE orders MODIFY COLUMN status
  ENUM('planned','matched','expired','confirmed','in_transit','delivered','cancelled')
  NOT NULL DEFAULT 'planned';

UPDATE orders SET order_type = 'erp_order'
  WHERE status IN ('confirmed', 'in_transit', 'delivered');
```
**Applied to production via phpMyAdmin.** Result: 18 confirmed + 11 in_transit + 15 delivered = all correctly classified as `erp_order`. ~10 planned/cancelled rows remain `purchase_order`.

### 2. Order.php — Model updates
- `baseSelect()`: Added `o.order_type`, `o.erp_order_id`, `o.matched_at`
- `all()`: Added `order_type` filter
- `create()`: Explicitly sets `order_type = 'purchase_order'`
- `cancel()`: Blocks cancellation of `matched`/`expired` POs; blocks ERP orders entirely
- NEW: `matchWithErp(int $poId, int $erpOrderId)`
- NEW: `markExpiredPOs()` — bulk UPDATE for past-deadline planned POs
- NEW: `findActivePO(int $stationId, int $fuelTypeId)` — for Procurement Advisor check
- NEW: `createErpOrder(array $data)` — creates erp_order + auto-matches to PO

### 3. OrderController.php
- `index()`: Added `Order::markExpiredPOs()` call + `order_type` filter from GET params

### 4. ForecastService.php
- Delivery bumps now restricted to ERP orders only:
  ```php
  AND o.order_type = 'erp_order'
  AND o.status NOT IN ('cancelled', 'delivered')
  ```

### 5. ProcurementAdvisorService.php
- Added `use App\Models\Order;`
- In `getUpcomingShortages()`: calls `Order::findActivePO()` for each shortage
- Returns `po_pending: bool` and `active_po: array|null` in each shortage entry

### 6. Orders.vue — Two Tabs
Complete rewrite with:
- **Tab 1: Purchase Orders** — filter by `order_type=purchase_order`; `planned/matched/expired/cancelled` statuses; New PO button; Print+Cancel for `planned` only
- **Tab 2: ERP Deliveries** — filter by `order_type=erp_order`; read-only, info banner; extra "Matched PO" column
- Separate filter state (`poFilters` / `erpFilters`) — switching tab preserves filters
- Both tabs loaded on mount for accurate count badges
- Status badges extended: `matched` = blue, `expired` = orange

### 7. ProcurementAdvisor.vue
- Added `useRouter` import
- `recommendations` computed now passes `po_pending` and `active_po` through
- Per-recommendation card:
  - If `po_pending`: blue "PO Issued — Awaiting ERP Confirmation" banner with PO details
  - Button: "View Purchase Orders" → router.push('/orders')
  - If no PO: "Create Order" → router.push('/orders')

---

## Deploy

```bash
npm run build  # ✅ 1.28s, 523KB JS bundle
git add ...    # staged all 12 changed/new files
git commit -m "feat: Orders module — PO vs ERP order type separation (migration 008)"
git push origin main
# Deploy triggered via: https://fuel.kittykat.tech/rev3/deploy.php?key=fuel2026deploy
# Result: ✅ Deployed at 2026-02-23 16:43:51
```

---

## Files Changed

| File | Change |
|------|--------|
| `database/migrations/008_order_type.sql` | NEW — migration applied to production |
| `backend/src/Models/Order.php` | Major: baseSelect + new methods |
| `backend/src/Controllers/OrderController.php` | Minor: order_type filter + markExpiredPOs |
| `backend/src/Services/ForecastService.php` | Minor: AND order_type='erp_order' |
| `backend/src/Services/ProcurementAdvisorService.php` | Minor: po_pending check |
| `frontend/src/views/Orders.vue` | Major rewrite: two tabs |
| `frontend/src/components/ProcurementAdvisor.vue` | Minor: PO badge + router buttons |
| `frontend/dist/` | Rebuilt from npm run build |

---

## Next Steps / Future Work

- **Import.vue** — Full UI to connect to erp.kittykat.tech, sync ERP orders
- **PO expiry warnings** — Badge on Dashboard for expired POs
- **ERP → PO link UI** — In ERP tab, show link to matched PO
- **Bulk import** — CSV/Excel import of ERP historical data
